{% extends 'base.html' %}
{% load static %}
{% load leaflet_tags %}

{% block title %}
  Facilities | BackOffice | {{ block.super }}
{% endblock %}

{% block extra_head %}
  {% leaflet_css %}
  <link href="{% static 'css/leaflet.css' %}" rel="stylesheet">
  <link href="{% static 'css/leaflet.awesome-markers.css' %}" rel="stylesheet">
  <link href="{% static 'modules/leaflet-fullscreen/leaflet.fullscreen.css' %}" rel="stylesheet">
  <script src="{% static 'js/leaflet-1.6.0.js' %}" type="text/javascript"></script>
  <script src="{% static 'js/proj4.js' %}" type="text/javascript"></script>
  <script src="{% static 'js/proj4leaflet.js' %}" type="text/javascript"></script>
  <script src="{% static 'js/leaflet.awesome-markers.min.js' %}" type="text/javascript"></script>
  <script src="{% static 'js/leaflet-color-markers.js' %}" type="text/javascript"></script>
  <script src="{% static 'modules/leaflet-fullscreen/Leaflet.fullscreen.min.js' %}" type="text/javascript"></script>
{% endblock extra_head %}

{% block content %}
  <div class="panel panel-default">
    <div class="panel-heading">
      <h3 class="panel-title">Facilities - BackOffice</h3>
    </div>
    <div class="panel-body">
      <p class="lead">The following {{ facility_list.count }} facilities are defined for {{ camp.title }}</p>
      <p>
        <a href="{% url 'backoffice:facility_create' camp_slug=camp.slug %}" class="btn btn-success"><i class="fas fa-plus"></i> Create Facility</a>
        <a class="btn btn-default" href="{% url 'backoffice:index' camp_slug=camp.slug %}"><i class="fas fa-undo"></i> Backoffice</a>
      </p>
      <table class="table datatable">
        <thead>
          <tr>
            <th>Name</th>
            <th>Type</th>
            <th>Team</th>
            <th>Description</th>
            <th>Location</th>
            <th class="text-center">Feedback / Unhandled</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for facility in facility_list %}
            <tr>
              <td>{{ facility.name }}</td>
              <td><i class="{{ facility.facility_type.icon }} fa-2x fa-fw"></i> {{ facility.facility_type.name }}</td>
              <td>{{ facility.team.name }} Team</td>
              <td>{{ facility.description|linebreaksbr|default:"N/A" }}</td>
              <td>{{ facility.location }}</td>
              <td class="text-center"><span class="badge">{{ facility.feedbacks.count }}</span> / <span class="badge">{{ facility.unhandled_feedbacks.count }}</span></td>
              <td>
                <div class="btn-group btn-group-vertical">
                  <a href="{% url "backoffice:facility_detail" camp_slug=camp.slug facility_uuid=facility.pk %}" class="btn btn-primary"><i class="fas fa-search"></i> Details</a>
                  <a href="{% url "backoffice:facility_update" camp_slug=camp.slug facility_uuid=facility.pk %}" class="btn btn-primary"><i class="fas fa-edit"></i> Update</a>
                  <a href="{% url "backoffice:facility_delete" camp_slug=camp.slug facility_uuid=facility.pk %}" class="btn btn-danger"><i class="fas fa-times"></i> Delete</a>
                </div>
              </td>
            </tr>
          {% endfor %}
        </table>
        <p>
          <div id="map" class="map"></div>

        </div>
      </div>
      <script src="{% static 'js/mapVars.js' %}" type="text/javascript"></script>
      <script src="{% static 'js/map.js' %}" type="text/javascript"></script>
      <script type="text/javascript">
        const mapObject = new BHMap("map");
        mapObject.setDefaultView();
        mapObject.map.addControl(new L.Control.Fullscreen({
          pseudoFullscreen: true,
        }));

        {% if request.user.is_authenticated %}
        const loggedIn = true;
        {% else %}
        const loggedIn = false;
        {% endif %}
        {% for facility in facilitytype_list %}
        {% url "facilities:facility_list_geojson" camp_slug=facility.responsible_team.camp.slug facility_type_slug=facility.slug as layerUrl %}
        mapObject.loadLayer("{{layerUrl}}", "{{facility.name}}", facilityOptions);
        {% endfor %}
        mapObject.loadLayer("{% static 'json/grid.geojson' %}", "Grid squares", {
          onEachFeature: mapObject.onEachGrid,
          style: {
            color: "gray",
            fillOpacity: 0.0,
            weight: 0.5
          },
        }, false);
        {% for facility in facility_list %}
        {% url "backoffice:facility_detail" camp_slug=facility.camp.slug facility_uuid=facility.uuid as detail %}
        L.marker([
            {{ facility.location.y }},
            {{ facility.location.x }}
        ], {
            icon: L.AwesomeMarkers.icon({
                icon: "{{ facility.facility_type.icon }}",
                markerColor: iconColors['{{ facility.facility_type.marker }}'],
                prefix: 'fa',
            }) 
        }).bindPopup("<b>{{ facility.name }}</b><br><p>{{ facility.description|linebreaksbr }}</p><p>Responsible team: {{ facility.facility_type.responsible_team.name }} Team</p>{% if request.user.is_authenticated %}<p><a href='{{ detail }}' class='btn btn-primary' style='color: white;'><i class='fas fa-search'></i> Details</a></p>{% endif %}").addTo(mapObject.map);
        {% endfor %}
      </script>

{% endblock %}

{% extends 'program_base.html' %}
{% load leaflet_tags %}
{% load static %}

{% block title %}
  Map | {{ block.super }}
{% endblock %}

{% block extra_head %}
  {% leaflet_css %}
  <link href="{% static 'css/leaflet.css' %}" rel="stylesheet">
  <link href="{% static 'css/leaflet.awesome-markers.css' %}" rel="stylesheet">
  <link href="{% static 'modules/leaflet-fullscreen/leaflet.fullscreen.css' %}" rel="stylesheet">
  <link href="{% static 'modules/leaflet-panel-layers/leaflet-panel-layers.min.css' %}" rel="stylesheet">
  <script src="{% static 'js/leaflet-1.6.0.js' %}" type="text/javascript"></script>
  <script src="{% static 'js/proj4.js' %}" type="text/javascript"></script>
  <script src="{% static 'js/proj4leaflet.js' %}" type="text/javascript"></script>
  <script src="{% static 'js/leaflet.awesome-markers.min.js' %}" type="text/javascript"></script>
  <script src="{% static 'js/leaflet-color-markers.js' %}" type="text/javascript"></script>
  <script src="{% static 'modules/leaflet-fullscreen/Leaflet.fullscreen.min.js' %}" type="text/javascript"></script>
  <script src="{% static 'modules/leaflet-panel-layers/leaflet-panel-layers.min.js' %}" type="text/javascript"></script>
{% endblock extra_head %}

{% block content %}
  <div class="panel panel-default">
    <div class="panel-heading">
      <h3 class="panel-title">Map</h3>
    </div>
    <div class="panel-body" id="container">
      <div id="map" class="map"></div>
    </div>

    <script src="{% static 'js/mapVars.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/mapProcessing.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/map.js' %}" type="text/javascript"></script>
    <script type="text/javascript">
      const mapObject = new BHMap("map");
      mapObject.setDefaultView();
      mapObject.map.addControl(new L.Control.Fullscreen({
        pseudoFullscreen: true, 
      }));
      mapObject.loadLayer("{% static 'json/grid.geojson' %}", "Grid squares", { 
        onEachFeature: mapObject.onEachGrid,
        style: { 
          color: "gray",
          fillOpacity: 0.0,
          weight: 0.5
        },
      }, false, gridLoaded(), "Generic", "fas fa-border-all");
      {% if request.user.is_authenticated %}
      const loggedIn = true;
      {% else %}
      const loggedIn = false;
      {% endif %}
      function gridLoaded() {
        console.log("Loaded grid layer");
        {% for facility in facilitytype_list %}
          {% url "facilities:facility_list_geojson" camp_slug=facility.responsible_team.camp.slug facility_type_slug=facility.slug as layerUrl %}
          mapObject.loadLayer("{{layerUrl}}", "{{facility.name}}", facilityOptions, true, function(){}, "Facilities", "{{ facility.icon }}");
        {% endfor %}
        {% for layer in layers %}
          {% url "maps:map_layer_geojson" layer_slug=layer.slug as layerUrl %}
          mapObject.loadLayer("{{layerUrl}}", "{{layer.name}}", {
            onEachFeature: function(feature, layer) {
              let content = `<b>${feature.properties.name}</b><br><p>${feature.properties.description}</p>`;
              if (feature.properties.url)
                content += `<br><p><a href='${feature.properties.url}' class='btn btn-primary' style='color: white;'><i class='fas fa-search'></i> Details</a></p>`

              layer.bindPopup(content, { maxHeight: 400});
              if (feature.properties.color !== "#FFFFFFFF") {
                layer.setStyle({
                  color: feature.properties.color
                })
              }
              if (layer.feature.geometry.type === 'GeometryCollection') {
                layer.eachLayer(function(l) {
                  if(l._latlng && l.setIcon){
                    l.setIcon(L.AwesomeMarkers.icon({
                      icon: feature.properties.icon.replace('fas fa-',''),
                      markerColor: iconColors[feature.properties.marker],
                      prefix: 'fa',
                    }))
                  }
                })
              }
            },
            pointToLayer: function(feature, latlng) {
              if (feature.properties.processing == "noisesensor")
                  return new L.CircleMarker(latlng, {
                      radius: 25,
                      color: '#FF0000'
                  });
              else
                  return L.marker(latlng)
            },
            style: {
              color: "{{ layer.color }}"
            }
          }, true, function(){}, "Generic", "fas fa-{{ layer.icon }}");
        {% endfor %}
        {% for layer in externalLayers %}
          mapObject.loadLayer("{{layer.url}}", "{{layer.name}}", {}, false, function(){}, "External");
        {% endfor %}
        {% url "villages_geojson" camp_slug=camp.slug as villageLayerUrl %}
        mapObject.loadLayer("{{ villageLayerUrl }}", "Villages", villageOptions, true, function(){}, undefined, "fa fa-campground");
      }
      mapObject.onGridClick = function (e) {
        let center = e.target.getCenter();
        alert(center.lat + "," + center.lng + " " + mapObject.cols[e.target.feature.properties.col_index - 2] + (e.target.feature.properties.row_index - 1));
      }
    </script>
    <script type="text/javascript">
mapObject.onMqtt("trafficlight/1", {"value":"green"})
mapObject.onMqtt("trafficlight/2", {"value":"red"})
mapObject.onMqtt("noisesensor/1", {"avg": 10.2})
mapObject.onMqtt("noisesensor/2", {"avg": 30.2})
var lightSide = 0;
let myVar2 = setInterval(myTimer2, 1000);

function getRandomLoc(min,max) {
 return Math.random() * (max - min) + min;
}

function myTimer2() {
  const tub = Math.floor(Math.random() * (45 - 20 + 1) + 20);
  mapObject.onMqtt("hottub", {"value":tub+""})
  let noice = Math.floor(Math.random() * (60 - 25 + 1) + 25);
  mapObject.onMqtt("noisesensor/1", {"avg": noice})
  noice = Math.floor(Math.random() * (60 - 25 + 1) + 25);
  mapObject.onMqtt("noisesensor/2", {"avg": noice})
}
let myVar = setInterval(myTimer, 3000);

function myTimer() {
  mapObject.onMqtt("golfcar", {
    "lat":getRandomLoc(55.39004471637513, 55.38379389032002),
    "lng":getRandomLoc(9.936828255477785, 9.945946155611598),
  });
  if (lightSide) {
    lightSide = 0
    mapObject.onMqtt("trafficlight/1", {"value":"green"})
    mapObject.onMqtt("trafficlight/2", {"value":"red"})
  } else {
    mapObject.onMqtt("trafficlight/2", {"value":"green"})
    mapObject.onMqtt("trafficlight/1", {"value":"red"})
    lightSide = 1
  }
}
    </script>

{% endblock %}

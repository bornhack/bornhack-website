{% extends 'base.html' %}
{% load static %}
{% load commonmark %}$
{% load token_tags %}
{% load humanize %}

{% block title %}
  Token game | {{ block.super }}
{% endblock %}

{% block extra_head %}
<script src="{% static 'vendor/apexcharts/apexcharts.min.js' %}"></script>
{{ widgets|json_script:"widgets" }}
<script src="{% static 'js/tokens/token_charts.js' %}"></script>
{% endblock extra_head %}

{% block content %}

  {% if object_list|length == 0 %}

    {% include 'includes/game_not_started.html' %}

  {% else %}

  <div class="row my-5">
    <div class="col-12 col-lg-6">
      <div class="mb-5">
        <h2>Token game dashboard</h2>
      </div>

      {% include 'includes/player_stats.html' %}

      <hr class="mt-4 mb-5">
      <div class="row">
        <div class="col-12 col-md-auto">
          <h3 class="mb-4">How to play?</h3>
          <p>The <b>token game</b> lasts the whole event and is about finding little text strings matching the regular expression:</p>
          <p><code>[0-9a-zA-Z\.@]{12,32}</code></p>
          <p>Token examples:</p>
          <p>
          <ul>
            <li><code>BornHack{{ camp.camp.lower.year }}</code></li>
            <li><code>cm9sbGllczIwMjR5b3V3aW4K</code></li>
            <li><code>Ly5caCRLKRHrpiF6SQwe9geUKAxSsLQE</code></li>
          </ul>
          </p>
          <p>Tokens are hidden or in plain sight physically or virtually on the BornHack venue, online and offline.</p>
          <p class="mb-0">You can start with this one: <b>HelloTokenHunters{{ camp.camp.lower.year }}</b></p>
        </div>
      </div>
      <div class="row">
        <div class="col-12 my-4">
          <form action="{% url 'tokens:submit' camp_slug=camp.slug %}" method="post">
            {% csrf_token %}
            <div class="input-group shadow-sm">
              <input type="text" class="form-control" placeholder="Token" name="token">
              <button type="submit" class="btn btn-outline-secondary">Submit</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-6 token-widgets">
      <div class="row g-3">
        <div class="col-12 col-md-6">
          {% include 'includes/total_players_widget.html' with widget=widgets.total_players %}
        </div>
        <div class="col-12 col-md-6">
          {% include 'includes/total_finds_widget.html' with widget=widgets.total_finds %}
        </div>
        <div class="col-12 col-md-6">
          {% include 'includes/token_categories_widget.html' with widget=widgets.token_categories %}
        </div>
        <div class="col-12 col-md-6">
          {% include 'includes/token_activity_widget.html' with widget=widgets.token_activity %}
        </div>
      </div>
    </div>
  </div>
  <div class="row my-4">
    <div class="col-12 mb-3">
      <h3>Your submitted tokens</h3>
    </div>
    <div class="col-12">
      <div class="table-responsive">
        <table class="table table-striped table-hover datatable submitted-tokens">
          <thead>
            <tr>
              <th>Category</th>
              <th>Active</th>
              <th>Time Limits</th>
              <th>Hint</th>
              <th>Token</th>
              <th>Description</th>
              <th>Found</th>
            </tr>
          </thead>
          <tbody>
            {% for token in object_list %}
              {% with token|found_by_user:user as user_has_found_token %}
              {% if user_has_found_token %}
              <tr class="table-success">
              {% else %}
              <tr>
              {% endif %}
                <td>{{ token.category.name }}</td>
                <td>
                  {% if token.is_valid_now %}
                    <i class="unhide-for-no-js-users text-success">&#10004;</i>
                    <i class="hide-for-no-js-users fas fa-check text-success"></i>
                  {% else %}
                    <i class="unhide-for-no-js-users text-danger">&#10060;</i>
                    <i class="hide-for-no-js-users fas fa-xmark text-danger"></i>
                  {% endif %}
                </td>
                <td>
                  {% if token.valid_when.lower %}
                    From {{ token.valid_when.lower }}<br>
                  {% endif %}
                  {% if token.valid_when.upper %}
                    To {{ token.valid_when.upper  }}
                  {% endif %}
                  {% if not token.valid_when %}
                    -
                  {% endif %}
                </td>
                <td>{{ token.hint }}</td>

                  {% if user_has_found_token %}
                    <td>{{ token.token }}</td>
                    <td>{{ token.description }}</td>
                    <td>{{ user_has_found_token }}</td>
                  {% else %}
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                  {% endif %}
              </tr>
              {% endwith %}
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

{% endif %}

{% endblock %}

{% extends 'base.html' %}
{% load static %}
{% load commonmark %}$
{% load token_tags %}
{% load humanize %}

{% block title %}
  Token game | {{ block.super }}
{% endblock %}

{% block extra_head %}
<script src="{% static 'vendor/apexcharts/apexcharts.min.js' %}"></script>
{{ widgets|json_script:"widgets" }}
<script src="{% static 'js/tokens/token_charts.js' %}"></script>
{% endblock extra_head %}

{% block content %}

  <div class="row my-4">
    <div class="col-12 col-lg-6">
      <div class="mb-5">
        <h2 class="mb-2">Token game dashboard</h2>
      </div>
      <div class="row justify-content-between g-4">
        <div class="col-4 col-md-auto me-4">
          <div class="d-flex align-items-center">
            <span>
             <i class="fa-solid fa-trophy fa-3x text-success"></i>
            </span>
            <div class="ms-3">
              <h5>{{ player_stats.tokens_found }} found</h5>
            </div>
          </div>
        </div>
        <div class="col-4 col-md-auto">
          <div class="d-flex align-items-center">
            <span>
             <i class="fa-solid fa-magnifying-glass fa-3x text-warning"></i>
            </span>
            <div class="ms-3">
              <h5>{{ player_stats.tokens_missing }} missing</h5>
            </div>
          </div>
        </div>
        <div class="col-4 col-md-auto">
          <div class="d-flex align-items-center">
            <span>
             <i class="fa-regular fa-rectangle-list fa-3x text-primary"></i>
            </span>
            <div class="ms-3">
              <h5>{{ player_stats.tokens_count }} total</h5>
            </div>
          </div>
        </div>
      </div>
      <hr class="my-4">
      <div class="row">
        <div class="col-12 col-md-auto">
          <h3 class="mb-3">How to play?</h3>
          <p>The <b>token game</b> lasts the whole event and is about finding little text strings matching the regular expression:</p>
          <p><code>[0-9a-zA-Z\.@]{12,32}</code></p>
          <p>Token examples:</p>
          <p>
          <ul>
            <li><code>BornHack{{ camp.year }}</code></li>
            <li><code>cm9sbGllczIwMjR5b3V3aW4K</code></li>
            <li><code>Ly5caCRLKRHrpiF6SQwe9geUKAxSsLQE</code></li>
          </ul>
          </p>
          <p>Tokens are hidden or in plain sight physically or virtually on the BornHack venue, online and offline.</p>
          <p>Submit the tokens you find in the field below.</p>
        </div>
        <div class="col-12">
          <form action="{% url 'tokens:submit' camp_slug=camp.slug %}" method="post">
            {% csrf_token %}
            <div class="input-group shadow-sm">
              <input type="text" class="form-control" placeholder="Token" name="token">
              <button type="submit" class="btn btn-outline-secondary">Submit</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="row g-3">
        <div class="col-12 col-md-6">
          <div class="card h-100 shadow">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h5>Total players</h5>
                  <p><b>Last join:</b> <small>{{ widgets.total_players.last_join_time | timesince }} ago.</small></p>
                </div>
                <p class="h4">{{ widgets.total_players.count }}</p>
              </div>
              <div id="total_players_chart"></div>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-6">
          <div class="card h-100 shadow">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h5>Tokens found</h5>
                  <p><b>Last found:</b> <small>{{ widgets.tokens_found.last_found | timesince }} ago.</small></p>
                </div>
                <p class="h4">{{ widgets.tokens_found.count }}</p>
              </div>
              <div id="tokens_found_chart"></div>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-6">
          <div class="card h-100 shadow">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div class="mb-0">
                  <h5>Token categories</h5>
                </div>
                <p class="h4">{{ widgets.token_categories.count }}</p>
              </div>
              <div id="token_category_chart"></div>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-6">
          <div class="card h-100 shadow">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div class="mb-0">
                  <h5>Token activity</h5>
                  <p class="mb-0"><small>Finds in last 60 min.</small></p>
                </div>
                <p class="h4">{{ widgets.token_activity.last_60m_count }}</p>
              </div>
              <div id="token_activity_chart"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="row my-4">
    <div class="col-12 mb-3">
      <h3>Your submitted tokens</h3>
    </div>
    <div class="col-12">
      <div class="table-responsive">
        <table class="table table-striped table-hover datatable">
          <thead>
            <tr>
              <th>Category</th>
              <th>Active</th>
              <th>Time Limits</th>
              <th>Hint</th>
              <th>Token</th>
              <th>Description</th>
              <th>Found</th>
            </tr>
          </thead>
          <tbody>
            {% for token in object_list %}
              <tr>
                <td>{{ token.category.name }}</td>
                <td>
                  {% if token.valid_now %}
                    <i class="fas fa-check text-success"></i>
                  {% else %}
                    <i class="fas fa-times text-danger"></i>
                  {% endif %}
                </td>
                <td>
                  {% if token.valid_when.lower %}
                    From {{ token.valid_when.lower }}<br>
                  {% endif %}
                  {% if token.valid_when.upper %}
                    To {{ token.valid_when.upper  }}
                  {% endif %}
                  {% if not token.valid_when %}
                    -
                  {% endif %}
                </td>
                <td>{{ token.hint }}</td>

                {% with token|found_by_user:user as user_has_found_token %}
                  {% if user_has_found_token %}
                    <td>{{ token.token }}</td>
                    <td>{{ token.description }}</td>
                    <td>{{ user_has_found_token }}</td>
                  {% else %}
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                  {% endif %}
                {% endwith %}

              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

{% endblock %}
